<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Agricultural Biotechnology Final Exam</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:#0f172a;color:#e5e7eb;}
  .wrap{max-width:960px;margin:0 auto;padding:24px;}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);}
  h1,h2{margin:0 0 10px 0;color:#e2e8f0;}
  ul{padding-left:18px;}
  .pill{padding:6px 10px;border-radius:999px;background:#111827;border:1px solid #1f2937;font-size:12px;margin-right:6px;}
  .meta-row{margin-bottom:10px;}
  .field{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;}
  input{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;flex:1;min-width:220px;}
  button{padding:10px 16px;border-radius:12px;border:1px solid #263042;background:#0b1326;color:#e5e7eb;cursor:pointer;}
  button.primary{background:#0d5a30;}
  button:disabled{opacity:.6;cursor:not-allowed;}
  .choice{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:10px;margin-bottom:10px;}
  .choice input{margin-right:8px;}
  .footer{display:flex;justify-content:space-between;gap:10px;margin-top:20px;}
  .progress{height:8px;background:#1f2937;border-radius:999px;margin-bottom:12px;}
  .bar{height:8px;background:#22c55e;width:0%;}
  .hidden{display:none;}
  .error{color:#fecaca;font-size:13px;margin-top:6px;}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Agricultural Biotechnology Final Exam</h1>

    <div id="meta" class="meta-row hidden">
      <span class="pill" id="pillName">Name: —</span>
      <span class="pill" id="pillSection">Year/Section: —</span>
      <span class="pill" id="pillTimer">Time: 60:00</span>
      <span class="pill" id="pillCount">Q: — / —</span>
    </div>

    <!-- Stage 0: Instructions -->
    <div id="stage0">
      <h2>Exam Instructions</h2>
      <ul>
        <li>This exam is <b>screen recorded</b>.</li>
        <li>You have <b>1 hour</b> to finish.</li>
        <li>You may take the exam <b>twice</b>. After the second attempt, attempts are blocked.</li>
        <li>The link closes at <b>11:59:59 PM on 21 November 2025</b>.</li>
      </ul>
      <p>Please make sure you have a stable internet connection before starting.</p>
      <div class="error" id="errStage0" style="display:none;"></div>
      <button class="primary" id="btnUnderstand">I understand</button>
    </div>

    <!-- Stage 1: Student Info -->
    <div id="stage1" class="hidden">
      <h2>Student Information</h2>
      <div class="field">
        <input id="inpName" placeholder="Full Name"/>
        <input id="inpSection" placeholder="Year & Section (e.g., BS Agri 2A)"/>
      </div>
      <div class="error" id="errStage1" style="display:none;"></div>
      <div class="footer">
        <button id="btnBack">Back</button>
        <button class="primary" id="btnStart">Next</button>
      </div>
    </div>

    <!-- Stage 2: Exam -->
    <div id="stage2" class="hidden">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <p id="qtext"></p>
      <div id="choices"></div>
      <div class="error" id="errStage2" style="display:none;"></div>
      <div class="footer">
        <button id="btnPrev">Review</button>
        <div>
          <button id="btnNext" class="primary">Next</button>
          <button id="btnSubmit" class="primary hidden">Submit</button>
        </div>
      </div>
    </div>

    <!-- Stage 3: Result -->
    <div id="stage3" class="hidden">
      <h2>Submission Complete ✅</h2>
      <p><b id="rName"></b> (<span id="rSection"></span>)</p>
      <p>Your Score: <b id="rScore"></b></p>
      <p class="error" id="rNote" style="display:none;"></p>
      <p class="small">Your full answer sheet (chosen answers and correct answers) has been saved to the database.</p>
    </div>

  </div>
</div>

<script type="module">
// ===== Questions embedded from agribiotech.odt =====
const QUESTIONS = [{"num": 1, "q": "Biocon agents such as compost activators are primarily used to:", "A": "Kill all microorganisms in compost", "B": "Speed up the decomposition of organic materials", "C": "Sterilize soil", "D": "Remove all moisture from compost", "ans": "B"}, {"num": 2, "q": "Which microorganism group is MOST commonly involved in compost activation and organic waste fermentation?", "A": "Viruses", "B": "Lactic acid bacteria and fungi", "C": "Helminths", "D": "Nematodes", "ans": "B"}, {"num": 3, "q": "Why are fermentation agents added to organic fertilizers?", "A": "To make the fertilizer smell good only", "B": "To promote controlled microbial activity that stabilizes nutrients", "C": "To increase the weight artificially", "D": "To remove all nutrients from the compost", "ans": "B"}, {"num": 4, "q": "A farmer wants faster composting of rice straw and animal manure. Which practice best applies the use of biocon agents?", "A": "Leaving the pile dry and uncovered", "B": "Spraying a commercial compost activator and maintaining moisture", "C": "Burning the residues on the field", "D": "Adding only synthetic fertilizer", "ans": "B"}, {"num": 5, "q": "Lab results show that compost treated with a fermentation agent has higher microbial activity and faster breakdown than untreated compost. What is the MOST logical analysis?", "A": "The activator had no effect", "B": "The activator enhanced microbial activity, improving decomposition", "C": "The activator killed all microbes", "D": "Fermentation agents always reduce compost quality", "ans": "B"}, {"num": 6, "q": "Biopharming refers to the use of:", "A": "Traditional plowing methods", "B": "Animals to weed the field", "C": "Crops or animals engineered to produce pharmaceutical products", "D": "Organic fertilizers in farms", "ans": "C"}, {"num": 7, "q": "Which is an example of biopharming?", "A": "Using cows to graze grass", "B": "Producing vaccines in transgenic plants", "C": "Applying manure to crops", "D": "Spraying herbicides", "ans": "B"}, {"num": 8, "q": "A company uses genetically modified maize to produce a human therapeutic protein. How does this apply biopharming?", "A": "Maize is only used as food", "B": "Maize acts as a factory for pharmaceutical protein production", "C": "Maize is used only as animal feed", "D": "Maize is burned after harvest", "ans": "B"}, {"num": 9, "q": "A concern is raised that biopharming crops might unintentionally mix with food crops. What is this mainly an example of?", "A": "Improved biodiversity", "B": "Possible gene flow and contamination risk", "C": "Better food quality", "D": "Guaranteed safety", "ans": "B"}, {"num": 10, "q": "A policy maker must decide whether to allow open-field trials of biopharming crops near food production areas. From a regulatory standpoint, how should this be evaluated?", "A": "Approve immediately without risk assessment", "B": "Reject all trials without discussion", "C": "Carefully weigh potential health, environmental, and economic risks versus benefits and require strict biosafety measures", "D": "Allow trials with no monitoring", "ans": "C"}, {"num": 11, "q": "Phytoremediation is best defined as the:", "A": "Use of chemicals to remove soil pollutants", "B": "Use of plants to absorb, stabilize, or detoxify contaminants", "C": "Burning contaminated soils", "D": "Deep plowing to bury pollutants", "ans": "B"}, {"num": 12, "q": "Which situation is most suitable for phytoremediation?", "A": "Lightly metal-contaminated soil with adequate plant growth", "B": "Extremely radioactive waste only", "C": "Clean, uncontaminated soil", "D": "Deep ocean pollution", "ans": "A"}, {"num": 13, "q": "A community uses sunflower to extract heavy metals from contaminated soil. This is an example of:", "A": "Chemical remediation", "B": "Phytoremediation using hyperaccumulator plants", "C": "Soil sterilization", "D": "Salinization", "ans": "B"}, {"num": 14, "q": "Soil tests show reduced metal concentration in the upper layer where certain plants were grown. What is the MOST likely analysis?", "A": "Metals disappeared naturally", "B": "Plants absorbed metals, supporting phytoremediation", "C": "Sampling error only", "D": "Metals became more toxic", "ans": "B"}, {"num": 15, "q": "When evaluating phytoremediation vs. soil excavation and disposal, which statement is most appropriate from a sustainability standpoint?", "A": "Excavation is always better", "B": "Phytoremediation can be more sustainable where time is available, as it is less disruptive and often cheaper", "C": "Phytoremediation is never effective", "D": "Only excavation protects the environment", "ans": "B"}, {"num": 16, "q": "\u201cFake seeds\u201d in agriculture usually refer to:", "A": "Seeds that are larger than normal", "B": "Seeds with falsified labels or poor genetic and physical quality sold as branded seeds", "C": "Any seed from farmers\u2019 fields", "D": "Seeds with high germination", "ans": "B"}, {"num": 17, "q": "Which sign may help a farmer understand that seeds might be fake or spurious?", "A": "Properly sealed, labeled packaging from a registered source", "B": "Very low germination and off-type plants compared with label claims", "C": "Seed tested by accredited labs", "D": "Documentation of certification", "ans": "B"}, {"num": 18, "q": "A farmer buys \u201chybrid rice seeds\u201d from an unknown vendor at a very low price and gets poor, non-uniform yield. How does this situation apply the problem of fake seeds?", "A": "Farmer used high quality certified seeds", "B": "The seed may have been fake or mislabelled, leading to poor performance", "C": "Hybrid seeds always fail", "D": "Low price always means better quality", "ans": "B"}, {"num": 19, "q": "Regional data show high incidence of crop failure linked to unregistered seed vendors. What is the most reasonable analysis?", "A": "Registered vendors cause the problem", "B": "Weak regulation and enforcement allow fake seed trade, harming yields", "C": "Seed quality has no effect on yield", "D": "Farmers do not need seed laws", "ans": "B"}, {"num": 20, "q": "A government considers stricter penalties and better monitoring for fake seed sellers. From a policy perspective, how should this be evaluated?", "A": "Unnecessary, because seed quality does not matter", "B": "Positive, as it protects farmers, yield, and integrity of seed systems", "C": "Harmful to all stakeholders", "D": "Only important for exporters", "ans": "B"}, {"num": 21, "q": "Vaccines in livestock are used primarily to:", "A": "Treat worms", "B": "Prevent specific infectious diseases by stimulating immunity", "C": "Increase body weight instantly", "D": "Reduce water consumption", "ans": "B"}, {"num": 22, "q": "Artificial insemination (AI) in cattle is best described as:", "A": "Natural mating by bulls", "B": "Manual insertion of semen into the female reproductive tract using collected semen", "C": "Use of hormones to induce heat", "D": "Surgical removal of ovaries", "ans": "B"}, {"num": 23, "q": "Multiple Ovulation and Embryo Transfer (MOET) is a technology that applies biotechnology by:", "A": "Destroying embryos in elite cows", "B": "Producing many embryos from a superior female and transferring them to recipients", "C": "Preventing reproduction", "D": "Reducing genetic gain", "ans": "B"}, {"num": 24, "q": "Probiotics are generally defined as:", "A": "Synthetic antibiotics", "B": "Live microorganisms that when administered in adequate amounts confer a health benefit", "C": "Chemical preservatives", "D": "Soil fumigants", "ans": "B"}, {"num": 25, "q": "A poultry farmer adds probiotics to feed and later observes improved gut health and reduced diarrhea. What is the MOST logical analysis?", "A": "Probiotics had no role", "B": "Probiotics likely supported beneficial gut microbes, improving health", "C": "Probiotics caused the disease", "D": "Gut health is unrelated to probiotics", "ans": "B"}, {"num": 26, "q": "A committee must decide whether to prioritize AI/MOET programs in national breeding plans. From a breeding and resource viewpoint, how should this be evaluated?", "A": "Not useful because natural mating is always superior", "B": "Potentially advantageous because AI/MOET can rapidly spread superior genetics if managed ethically and sustainably", "C": "Always harmful to breeds", "D": "Unrelated to genetic improvement", "ans": "B"}, {"num": 27, "q": "One promise of future biotechnology in agriculture is to:", "A": "Produce crops with lower resilience", "B": "Develop stress-tolerant, nutrient-efficient varieties", "C": "Eliminate all biodiversity", "D": "Replace all traditional knowledge", "ans": "B"}, {"num": 28, "q": "\u201cBiotech products nearing commercialization\u201d often include crops that:", "A": "Have no useful traits", "B": "May carry traits such as drought tolerance, biofortification, or disease resistance", "C": "Only change plant color", "D": "Remove all natural defenses", "ans": "B"}, {"num": 29, "q": "A breeding program uses biotechnology to create rice with enhanced vitamin A content (e.g., biofortified rice). How does this apply biotechnology to public health?", "A": "It ignores nutrition issues", "B": "It aims to reduce micronutrient deficiency in populations dependent on rice", "C": "It reduces yield only", "D": "It targets only cosmetic traits", "ans": "B"}, {"num": 30, "q": "Data show that a biotech crop reduces pesticide use but may increase dependence on a few seed suppliers. What is the best analysis of its role in a sustainable future?", "A": "Benefits and risks are both present\u2014less chemical use vs. potential seed access issues", "B": "All biotech crops are always harmful", "C": "Only seed dependence matters", "D": "Only pesticide reduction matters", "ans": "A"}, {"num": 31, "q": "When evaluating future biotech options for sustainable agriculture, which reasoning is most appropriate?", "A": "Accept all biotech instantly", "B": "Reject all biotech absolutely", "C": "Carefully assess each product\u2019s ecological, social, and economic impacts relative to alternatives", "D": "Decide only on the basis of short-term profit", "ans": "C"}, {"num": 32, "q": "The main purpose of biosafety regulations in biotechnology is to:", "A": "Stop all research", "B": "Ensure safe development, handling, and use of biotech products", "C": "Promote uncontrolled release of GMOs", "D": "Replace traditional agriculture", "ans": "B"}, {"num": 33, "q": "Which international agreement is specifically concerned with the transboundary movement of living modified organisms (LMOs)?", "A": "Paris Agreement", "B": "Cartagena Protocol on Biosafety", "C": "Kyoto Protocol", "D": "Basel Convention on Hazardous Wastes", "ans": "B"}, {"num": 34, "q": "Local biosafety regulations generally aim to help people understand that:", "A": "Biotech products require no risk assessment", "B": "There is a structured system for risk assessment, approval, and monitoring", "C": "Only foreign experts can decide", "D": "Farmers have no role", "ans": "B"}, {"num": 35, "q": "A regulatory body requires environmental risk assessment before releasing a new GM crop. How does this apply the principles behind biosafety laws?", "A": "It ignores ecological concerns", "B": "It operationalizes precaution and risk-based decision making", "C": "It accelerates release without data", "D": "It bans all GM crops automatically", "ans": "B"}, {"num": 36, "q": "Monitoring reports show that a regulatory institution lacks capacity and coordination, leading to slow and inconsistent decisions. What is the best analysis?", "A": "Regulation is unnecessary", "B": "Weak institutions undermine effective biosafety governance and trust", "C": "Slow decisions mean better safety", "D": "Institutions are irrelevant", "ans": "B"}, {"num": 37, "q": "A national biotech law emphasizes transparency, public participation, and risk-benefit analysis. From a governance viewpoint, how should this be evaluated?", "A": "Negative, because public involvement complicates decisions", "B": "Positive, because it promotes accountability, inclusiveness, and informed decision making", "C": "Neutral, since laws never affect trust", "D": "Unimportant to biosafety", "ans": "B"}, {"num": 38, "q": "\u201cAlternatives in biotechnology\u201d can refer to:", "A": "Only chemical-intensive practices", "B": "Using non-GM breeding, integrated pest management, or ecological approaches alongside or instead of GM tools", "C": "Stopping all crop improvement", "D": "Burning crop fields", "ans": "B"}, {"num": 39, "q": "A farmer chooses marker-assisted selection and organic pest management instead of GM crops. This is an example of:", "A": "Rejecting all technology", "B": "Using alternative biotechnological and ecological approaches", "C": "Avoiding crop improvement altogether", "D": "Illegal practice", "ans": "B"}, {"num": 40, "q": "Comparing GM-based pest resistance with integrated pest management (IPM), which statement shows a balanced analysis?", "A": "GM is always better than IPM", "B": "IPM is always better than GM", "C": "Both approaches have roles; their suitability depends on local ecology, economics, and risk considerations", "D": "Neither approach is useful", "ans": "C"}, {"num": 41, "q": "A policy prioritizes only high-tech biotech while ignoring local, low-cost alternatives. From a sustainability and equity perspective, how should this be evaluated?", "A": "Ideal for all farmers", "B": "Potentially inequitable and less sustainable for resource-poor farmers", "C": "Neutral", "D": "Always the best choice", "ans": "B"}, {"num": 42, "q": "Which statement best describes the role of institutions (universities, research centers, regulators) in biotechnology?", "A": "They only sell products", "B": "They generate knowledge, assess risks, train people, and help guide safe application", "C": "They stop all innovation", "D": "They only serve private companies", "ans": "B"}, {"num": 43, "q": "A research institute develops a probiotic-based compost activator to help small farmers. How does this apply biotechnology for sustainability?", "A": "It increases chemical pesticide use", "B": "It offers a biological tool to enhance soil health and waste recycling", "C": "It reduces soil organic matter", "D": "It encourages burning residues", "ans": "B"}, {"num": 44, "q": "Data show that farms using probiotics, phytoremediation, and compost activators have improved soil quality and reduced chemical inputs. What can be reasonably concluded?", "A": "These biotechnologies are harmful", "B": "These biotechnologies can contribute to more sustainable soil management", "C": "Soil quality is unrelated to management", "D": "Chemicals are always superior", "ans": "B"}, {"num": 45, "q": "When selecting between a pharma-producing GM crop (biopharming) and conventional pharmaceutical production in factories, what is a key factor to evaluate?", "A": "Only the color of the plant", "B": "Environmental, biosafety, containment, and economic considerations of each route", "C": "The company logo", "D": "Popularity on social media", "ans": "B"}, {"num": 46, "q": "In AI/MOET programs, which aspect is MOST important to remember in planning? Level of thinking: Remembering", "A": "Only coat color of animals", "B": "Selection of genetically superior and healthy donors and sires", "C": "Random selection of animals", "D": "Ignoring disease control", "ans": "B"}, {"num": 47, "q": "A biopharming crop is proposed to be grown in a region with weak regulatory capacity and high risk of mixing with food crops. What is the MOST appropriate analysis?", "A": "No concern because biotech is always safe", "B": "The context increases biosafety and contamination risks and demands strong precaution", "C": "It guarantees better food quality", "D": "It has only economic benefits", "ans": "B"}, {"num": 48, "q": "A multi-stakeholder platform (farmers, NGOs, scientists, regulators) is created to discuss GM crop adoption. From a governance viewpoint, how should this be evaluated?", "A": "Unnecessary delay", "B": "Valuable for incorporating diverse perspectives and building social legitimacy", "C": "Always anti-technology", "D": "Irrelevant to decision-making", "ans": "B"}, {"num": 49, "q": "Which of the following is a correct understanding of how vaccines differ from probiotics in livestock production?", "A": "Vaccines directly kill pathogens; probiotics are only vitamins", "B": "Vaccines stimulate specific immune responses; probiotics support gut health and microbial balance", "C": "Both are exactly the same", "D": "Probiotics always replace vaccination", "ans": "B"}, {"num": 50, "q": "A country invests in regulations, training, and infrastructure for biosafety while also supporting alternative and low-cost biotechnologies. From a long-term sustainability perspective, how should this strategy be evaluated?", "A": "Wasteful, since only one technology is needed", "B": "Positive, because it balances innovation, safety, and inclusiveness for different types of farmers", "C": "Harmful, as it limits choices", "D": "Neutral, with no real impact \u2705", "ans": "B"}];


import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs, doc, setDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
  authDomain: "kuya-quiz-100.firebaseapp.com",
  projectId: "kuya-quiz-100",
  storageBucket: "kuya-quiz-100.appspot.com",
  messagingSenderId: "74623975270",
  appId: "1:74623975270:web:dec2b21dbee017292952a7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
try {
  await signInAnonymously(auth);
} catch(e) {
  console.warn("Anonymous auth failed:", e);
}

// Exam constants
const EXAM_DOC_ID = "KzRzubb5df1TV1gL2RuF";
const COURSE_TITLE = document.title;
const EXAM_SECONDS = 60 * 60;
const CLOSING_TIME = new Date(2025, 10, 21, 23, 59, 59); // month 10 = November

// DOM
const stage0 = document.getElementById("stage0");
const stage1 = document.getElementById("stage1");
const stage2 = document.getElementById("stage2");
const stage3 = document.getElementById("stage3");

const errStage0 = document.getElementById("errStage0");
const errStage1 = document.getElementById("errStage1");
const errStage2 = document.getElementById("errStage2");

const btnUnderstand = document.getElementById("btnUnderstand");
const btnBack = document.getElementById("btnBack");
const btnStart = document.getElementById("btnStart");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const btnSubmit = document.getElementById("btnSubmit");

const inpName = document.getElementById("inpName");
const inpSection = document.getElementById("inpSection");

const qtext = document.getElementById("qtext");
const choicesEl = document.getElementById("choices");
const barEl = document.getElementById("bar");

const metaRow = document.getElementById("meta");
const pillName = document.getElementById("pillName");
const pillSection = document.getElementById("pillSection");
const pillTimer = document.getElementById("pillTimer");
const pillCount = document.getElementById("pillCount");

const rName = document.getElementById("rName");
const rSection = document.getElementById("rSection");
const rScore = document.getElementById("rScore");
const rNote = document.getElementById("rNote");

// State
let currentIndex = 0;
let selectedAnswers = new Array(QUESTIONS.length).fill(null);
let secondsLeft = EXAM_SECONDS;
let timerId = null;
let studentId = null;
let studentName = "";
let studentSection = "";
let submitting = false;

// Helpers
function isClosed() {
  const now = new Date();
  return now > CLOSING_TIME;
}

function showErr(el, msg) {
  el.textContent = msg;
  el.style.display = msg ? "block" : "none";
}

function switchStage(stage) {
  stage0.classList.add("hidden");
  stage1.classList.add("hidden");
  stage2.classList.add("hidden");
  stage3.classList.add("hidden");
  stage.classList.remove("hidden");
}

function renderQuestion() {
  const q = QUESTIONS[currentIndex];
  qtext.textContent = q.q;
  choicesEl.innerHTML = "";
  const letters = ["A","B","C","D"];
  for (let i = 0; i < letters.length; i++) {
    const l = letters[i];
    const checked = selectedAnswers[currentIndex] === l ? " checked" : "";
    const html = '<label class="choice">' +
                 '<input type="radio" name="opt" value="' + l + '"' + checked + '>' +
                 '<b>' + l + '.</b> ' + q[l] +
                 '</label>';
    choicesEl.insertAdjacentHTML("beforeend", html);
  }
  pillCount.textContent = "Q: " + (currentIndex + 1) + " / " + QUESTIONS.length;
  if (QUESTIONS.length > 1) {
    const pct = (currentIndex / (QUESTIONS.length - 1)) * 100;
    barEl.style.width = pct + "%";
  } else {
    barEl.style.width = "0%";
  }
  btnPrev.disabled = currentIndex === 0;
  if (currentIndex === QUESTIONS.length - 1) {
    btnNext.classList.add("hidden");
    btnSubmit.classList.remove("hidden");
  } else {
    btnNext.classList.remove("hidden");
    btnSubmit.classList.add("hidden");
  }
  showErr(errStage2, "");
}

function getSelectedValue() {
  const sel = choicesEl.querySelector("input[name='opt']:checked");
  return sel ? sel.value : null;
}

function startTimer() {
  secondsLeft = EXAM_SECONDS;
  pillTimer.textContent = "Time: 60:00";
  if (timerId) {
    clearInterval(timerId);
  }
  timerId = setInterval(function() {
    secondsLeft -= 1;
    if (secondsLeft < 0) secondsLeft = 0;
    const m = Math.floor(secondsLeft / 60);
    const s = secondsLeft % 60;
    pillTimer.textContent = "Time: " +
      String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    if (secondsLeft <= 0) {
      clearInterval(timerId);
      timerId = null;
      autoSubmit();
    }
  }, 1000);
}

async function getAttemptCountForStudent(id) {
  try {
    const attemptsCol = collection(db, "finals-exam", EXAM_DOC_ID, "submissions", id, "attempts");
    const snap = await getDocs(attemptsCol);
    return snap.size;
  } catch (e) {
    console.warn("Attempt count check failed:", e);
    return 0;
  }
}

function computeScore() {
  let score = 0;
  for (let i = 0; i < QUESTIONS.length; i++) {
    const q = QUESTIONS[i];
    if (selectedAnswers[i] && selectedAnswers[i] === q.ans) {
      score += 1;
    }
  }
  return score;
}

function buildAnswerSheet() {
  const out = [];
  for (let i = 0; i < QUESTIONS.length; i++) {
    const q = QUESTIONS[i];
    out.push({
      questionNumber: q.num,
      question: q.q,
      options: { A: q.A, B: q.B, C: q.C, D: q.D },
      correctAnswer: q.ans,
      chosenAnswer: selectedAnswers[i],
      isCorrect: selectedAnswers[i] === q.ans
    });
  }
  return out;
}

// Main actions
btnUnderstand.addEventListener("click", function() {
  if (isClosed()) {
    showErr(errStage0, "This exam is already closed. Deadline was 11:59:59 PM on 21 November 2025.");
    return;
  }
  showErr(errStage0, "");
  switchStage(stage1);
});

btnBack.addEventListener("click", function() {
  switchStage(stage0);
});

btnStart.addEventListener("click", async function() {
  if (isClosed()) {
    showErr(errStage1, "This exam is already closed. Deadline was 11:59:59 PM on 21 November 2025.");
    return;
  }
  const nm = inpName.value.trim();
  const sec = inpSection.value.trim();
  if (!nm) {
    showErr(errStage1, "Please enter your full name.");
    return;
  }
  if (!sec) {
    showErr(errStage1, "Please enter your Year & Section.");
    return;
  }
  showErr(errStage1, "");

  studentName = nm;
  studentSection = sec;
  // studentId from name+section+course
  let raw = nm + "|||" + sec + "|||" + COURSE_TITLE;
  let base;
  try {
    base = btoa(unescape(encodeURIComponent(raw)));
  } catch (e) {
    base = raw;
  }
  studentId = base.replace(/[^A-Za-z0-9]/g, "").slice(0,80) || "student";

  const attemptCount = await getAttemptCountForStudent(studentId);
  if (attemptCount >= 2) {
    showErr(errStage1, "You have already used your 2 allowed attempts. Further attempts are blocked.");
    return;
  }

  metaRow.classList.remove("hidden");
  pillName.textContent = "Name: " + studentName;
  pillSection.textContent = "Year/Section: " + studentSection;
  pillCount.textContent = "Q: 1 / " + QUESTIONS.length;

  currentIndex = 0;
  selectedAnswers = new Array(QUESTIONS.length).fill(null);

  switchStage(stage2);
  renderQuestion();
  startTimer();
});

btnNext.addEventListener("click", function() {
  const sel = getSelectedValue();
  if (!sel) {
    showErr(errStage2, "Please choose an answer before proceeding.");
    return;
  }
  selectedAnswers[currentIndex] = sel;
  if (currentIndex < QUESTIONS.length - 1) {
    currentIndex += 1;
    renderQuestion();
  }
});

btnPrev.addEventListener("click", function() {
  const sel = getSelectedValue();
  if (sel) {
    selectedAnswers[currentIndex] = sel;
  }
  if (currentIndex > 0) {
    currentIndex -= 1;
    renderQuestion();
  }
});

btnSubmit.addEventListener("click", function() {
  const sel = getSelectedValue();
  if (!sel) {
    showErr(errStage2, "Please choose an answer before submitting.");
    return;
  }
  selectedAnswers[currentIndex] = sel;
  submitExam(false);
});

async function submitExam(autoSubmitted) {
  if (submitting) return;
  submitting = true;
  btnSubmit.disabled = true;
  btnNext.disabled = true;
  btnPrev.disabled = true;
  showErr(errStage2, "");
  if (timerId) {
    clearInterval(timerId);
    timerId = null;
  }

  const score = computeScore();
  const answerSheet = buildAnswerSheet();

  const payload = {
    Course: COURSE_TITLE,
    submissionDate: serverTimestamp(),
    Score: score,
    Name: studentName,
    secondsRemaining: secondsLeft,
    section: studentSection,
    answers: answerSheet,
    autoSubmitted: !!autoSubmitted
  };

  try {
    const attemptsCol = collection(db, "finals-exam", EXAM_DOC_ID, "submissions", studentId, "attempts");
    const snap = await getDocs(attemptsCol);
    const attemptNum = snap.size + 1;
    const ref = doc(db, "finals-exam", EXAM_DOC_ID, "submissions", studentId, "attempts", "attempt" + attemptNum);
    await setDoc(ref, payload);

    alert("your exam has been submitted");
    rName.textContent = studentName;
    rSection.textContent = studentSection;
    rScore.textContent = score + " / " + QUESTIONS.length;
    switchStage(stage3);
  } catch (e) {
    console.error("Submission failed:", e);
    alert("submission fail, please try again");
    // re-enable submit so they can retry
    btnSubmit.disabled = false;
    btnNext.disabled = false;
    btnPrev.disabled = currentIndex === 0;
    // restart timer (optional); here we keep remaining seconds
    if (!timerId && secondsLeft > 0) {
      startTimer();
    }
    submitting = false;
    return;
  }

  submitting = false;
}

async function autoSubmit() {
  if (submitting) return;
  const sel = getSelectedValue();
  if (sel) {
    selectedAnswers[currentIndex] = sel;
  }
  await submitExam(true);
}

pillTimer.textContent = "Time: 60:00";
pillCount.textContent = "Q: — / " + QUESTIONS.length;
</script>
</body>
</html>
