<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Agricultural Biotechnology Final Exam</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 900px;
            width: 100%;
            padding: 24px;
        }
        h1, h2, h3 {
            color: #fbbf24;
            margin-top: 0;
        }
        .card {
            background: rgba(15,23,42,0.9);
            border-radius: 16px;
            padding: 24px 24px 28px;
            box-shadow: 0 24px 60px rgba(15,23,42,0.8);
            border: 1px solid rgba(148,163,184,0.4);
        }
        .hidden {
            display: none;
        }
        ul {
            margin-top: 0;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
            box-sizing: border-box;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 1px rgba(251,191,36,0.6);
        }
        .field-group {
            margin-bottom: 16px;
        }
        .button-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 16px;
        }
        button {
            border: none;
            border-radius: 999px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #fbbf24, #f97316);
            color: #111827;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        button.secondary {
            background: transparent;
            color: #e5e7eb;
            border: 1px solid #6b7280;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .meta {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 8px;
        }
        .timer {
            font-weight: 700;
            font-size: 1.1rem;
            color: #f97316;
        }
        .question-text {
            font-size: 1.05rem;
            margin-bottom: 16px;
        }
        .options {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .options li {
            margin-bottom: 8px;
        }
        .options label {
            font-weight: 500;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            font-size: 0.95rem;
        }
        .status-bar span {
            color: #9ca3af;
        }
        .footer-note {
            margin-top: 16px;
            font-size: 0.8rem;
            color: #6b7280;
        }
        .error {
            color: #fecaca;
            font-size: 0.9rem;
            margin-top: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- STEP 1: Instructions -->
    <div id="step1" class="card">
        <h1>Final Examination Instructions</h1>
        <p class="meta">
            Please read everything carefully before proceeding. By clicking <strong>"I understand"</strong>, you agree to follow all exam rules.
        </p>
        <ul>
            <li>The exam session is <strong>screen recorded</strong>.</li>
            <li>The time limit is <strong>1 hour</strong>.</li>
            <li>You may take the exam <strong>twice only</strong>. After your second submission, all further attempts will be blocked.</li>
            <li>At <strong>11:59:59 PM, 20 November 2025</strong>, this exam link will be <strong>closed</strong>.</li>
        </ul>
        <p class="footer-note">
            Note: Do not refresh the page while taking the exam. Make sure you have a stable internet connection.
        </p>
        <div class="button-row">
            <button id="understandBtn">I understand</button>
        </div>
        <p id="closingMessage" class="error hidden"></p>
    </div>

    <!-- STEP 1b: Student info -->
    <div id="studentInfoCard" class="card hidden">
        <h2>Student Information</h2>
        <div class="field-group">
            <label for="studentName">Full Name</label>
            <input type="text" id="studentName" placeholder="e.g. Juan Dela Cruz" />
        </div>
        <div class="field-group">
            <label for="studentSection">Year and Section</label>
            <input type="text" id="studentSection" placeholder="e.g. BSAgri 3A" />
        </div>
        <p class="footer-note">
            Make sure your name and section are correct. These will appear on your exam record.
        </p>
        <div id="infoError" class="error hidden"></div>
        <div class="button-row">
            <button class="secondary" id="backToInstructionsBtn">Back</button>
            <button id="startExamBtn">Next</button>
        </div>
    </div>

    <!-- STEP 2: Exam -->
    <div id="examCard" class="card hidden">
        <div class="status-bar">
            <div>
                <span id="courseLabel"></span><br />
                <span id="studentLabel"></span>
            </div>
            <div>
                <span>Time remaining:</span>
                <span class="timer" id="timerDisplay">60:00</span>
            </div>
        </div>

        <h2 id="questionHeader">Question</h2>
        <p class="question-text" id="questionText"></p>
        <ul class="options" id="optionsList"></ul>
        <div id="questionError" class="error hidden"></div>

        <div class="button-row">
            <button class="secondary" id="reviewBtn">Review</button>
            <button id="nextBtn">Next</button>
            <button id="submitBtn" class="hidden">Submit</button>
        </div>
        <p class="footer-note">
            Use <strong>Review</strong> to go back to the previous question. Your chosen answers are remembered.
        </p>
    </div>
</div>

<!-- Firebase + Exam Logic -->
<script type="module">
    // ===============================
    // 1. FIREBASE INITIALIZATION
    // ===============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
        getFirestore,
        collection,
        addDoc,
        query,
        where,
        getDocs,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // TODO: Replace this with your real Firebase config from the Firebase console.
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY_HERE",
        authDomain: "YOUR_AUTH_DOMAIN_HERE",
        projectId: "YOUR_PROJECT_ID_HERE",
        storageBucket: "YOUR_STORAGE_BUCKET_HERE",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE",
        appId: "YOUR_APP_ID_HERE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // finals-exam collection -> specific exam document -> submissions subcollection
    const EXAM_DOC_ID = "KzRzubb5df1TV1gL2RuF"; // from your screenshot
    const submissionsCollectionRef = collection(db, "finals-exam", EXAM_DOC_ID, "submissions");

    // ===============================
    // 2. EXAM CONFIG
    // ===============================
    const courseTitle = document.title; // e.g. "Agricultural Biotechnology Final Exam"
    const examDurationSeconds = 60 * 60; // 1 hour
    const examClosingTime = new Date(2025, 10, 20, 23, 59, 59); // NOTE: month is 0-based (10 = November)

    // Define your questions here.
    // Edit this array to match your real exam questions and choices.
    const questions = [
        {
            text: "Sample question 1: Which letter comes first in the English alphabet?",
            options: ["C", "B", "A", "D"],
            correctIndex: 2
        },
        {
            text: "Sample question 2: 2 + 2 = ?",
            options: ["3", "4", "5", "22"],
            correctIndex: 1
        },
        {
            text: "Sample question 3: Which of the following is a color?",
            options: ["Dog", "Blue", "Rice", "Chair"],
            correctIndex: 1
        }
    ];

    // ===============================
    // 3. STATE
    // ===============================
    let currentQuestionIndex = 0;
    let answers = Array(questions.length).fill(null); // store selected option index
    let remainingSeconds = examDurationSeconds;
    let timerInterval = null;
    let studentName = "";
    let studentSection = "";

    // ===============================
    // 4. DOM ELEMENTS
    // ===============================
    const step1Card = document.getElementById("step1");
    const studentInfoCard = document.getElementById("studentInfoCard");
    const examCard = document.getElementById("examCard");

    const understandBtn = document.getElementById("understandBtn");
    const backToInstructionsBtn = document.getElementById("backToInstructionsBtn");
    const startExamBtn = document.getElementById("startExamBtn");

    const studentNameInput = document.getElementById("studentName");
    const studentSectionInput = document.getElementById("studentSection");
    const infoError = document.getElementById("infoError");

    const closingMessage = document.getElementById("closingMessage");

    const courseLabel = document.getElementById("courseLabel");
    const studentLabel = document.getElementById("studentLabel");
    const timerDisplay = document.getElementById("timerDisplay");

    const questionHeader = document.getElementById("questionHeader");
    const questionText = document.getElementById("questionText");
    const optionsList = document.getElementById("optionsList");
    const questionError = document.getElementById("questionError");

    const reviewBtn = document.getElementById("reviewBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");

    // ===============================
    // 5. UTILS
    // ===============================
    function isExamClosed() {
        const now = new Date();
        return now > examClosingTime;
    }

    function updateClosingMessageIfNeeded() {
        if (isExamClosed()) {
            closingMessage.textContent = "This exam is now closed. The deadline was 11:59:59 PM on 20 November 2025.";
            closingMessage.classList.remove("hidden");
            understandBtn.disabled = true;
            startExamBtn.disabled = true;
        }
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        const mm = m.toString().padStart(2, "0");
        const ss = s.toString().padStart(2, "0");
        return mm + ":" + ss;
    }

    function renderQuestion(index) {
        const q = questions[index];
        questionHeader.textContent = "Question " + (index + 1) + " of " + questions.length;
        questionText.textContent = q.text;

        // Clear previous options
        optionsList.innerHTML = "";

        q.options.forEach((opt, optIndex) => {
            const li = document.createElement("li");
            const label = document.createElement("label");
            const input = document.createElement("input");
            input.type = "radio";
            input.name = "option";
            input.value = optIndex.toString();

            if (answers[index] === optIndex) {
                input.checked = true;
            }

            label.appendChild(input);
            label.appendChild(document.createTextNode(" " + opt));
            li.appendChild(label);
            optionsList.appendChild(li);
        });

        // Handle buttons visibility
        reviewBtn.disabled = index === 0;
        nextBtn.classList.toggle("hidden", index === questions.length - 1);
        submitBtn.classList.toggle("hidden", index !== questions.length - 1);

        questionError.classList.add("hidden");
        questionError.textContent = "";
    }

    function saveCurrentAnswer() {
        const selected = document.querySelector('input[name="option"]:checked');
        if (selected) {
            const selectedIndex = parseInt(selected.value, 10);
            answers[currentQuestionIndex] = selectedIndex;
            return true;
        } else {
            return false;
        }
    }

    function startTimer() {
        remainingSeconds = examDurationSeconds;
        timerDisplay.textContent = formatTime(remainingSeconds);

        timerInterval = setInterval(() => {
            remainingSeconds -= 1;
            if (remainingSeconds < 0) remainingSeconds = 0;
            timerDisplay.textContent = formatTime(remainingSeconds);

            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
                alert("Time is up! Your exam will be submitted automatically.");
                handleSubmit(true); // auto-submit flag
            }
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    function computeScore() {
        let score = 0;
        for (let i = 0; i < questions.length; i++) {
            if (answers[i] === questions[i].correctIndex) {
                score += 1;
            }
        }
        return score;
    }

    function buildAnswerSheet() {
        return questions.map((q, idx) => {
            const chosenIndex = answers[idx];
            return {
                questionNumber: idx + 1,
                question: q.text,
                chosenOption: chosenIndex != null ? q.options[chosenIndex] : null,
                chosenOptionIndex: chosenIndex != null ? chosenIndex : null,
                correctOption: q.options[q.correctIndex],
                correctOptionIndex: q.correctIndex,
                isCorrect: chosenIndex === q.correctIndex
            };
        });
    }

    async function getAttemptCount(name, section) {
        try {
            const attemptsQuery = query(
                submissionsCollectionRef,
                where("Name", "==", name),
                where("section", "==", section),
                where("Course", "==", courseTitle)
            );
            const snapshot = await getDocs(attemptsQuery);
            return snapshot.size;
        } catch (err) {
            console.error("Error checking attempts:", err);
            // In case of error, allow attempt (returns 0 so we don't block).
            return 0;
        }
    }

    // ===============================
    // 6. EVENT HANDLERS
    // ===============================
    understandBtn.addEventListener("click", () => {
        if (isExamClosed()) {
            updateClosingMessageIfNeeded();
            return;
        }
        step1Card.classList.add("hidden");
        studentInfoCard.classList.remove("hidden");
    });

    backToInstructionsBtn.addEventListener("click", () => {
        studentInfoCard.classList.add("hidden");
        step1Card.classList.remove("hidden");
    });

    startExamBtn.addEventListener("click", async () => {
        if (isExamClosed()) {
            updateClosingMessageIfNeeded();
            return;
        }

        studentName = studentNameInput.value.trim();
        studentSection = studentSectionInput.value.trim();

        if (!studentName || !studentSection) {
            infoError.textContent = "Please enter both your full name and your year & section.";
            infoError.classList.remove("hidden");
            return;
        } else {
            infoError.classList.add("hidden");
        }

        // Check attempt count from Firestore
        const attempts = await getAttemptCount(studentName, studentSection);
        if (attempts >= 2) {
            infoError.textContent = "You have already used your 2 allowed attempts for this exam. Further attempts are blocked.";
            infoError.classList.remove("hidden");
            return;
        }

        // Proceed to exam
        studentInfoCard.classList.add("hidden");
        examCard.classList.remove("hidden");

        courseLabel.textContent = courseTitle;
        studentLabel.textContent = studentName + " | " + studentSection;

        currentQuestionIndex = 0;
        answers = Array(questions.length).fill(null);
        renderQuestion(currentQuestionIndex);
        startTimer();
    });

    reviewBtn.addEventListener("click", () => {
        if (currentQuestionIndex === 0) return;
        // Save current answer
        saveCurrentAnswer();
        currentQuestionIndex -= 1;
        renderQuestion(currentQuestionIndex);
    });

    nextBtn.addEventListener("click", () => {
        // Ensure an answer is selected
        if (!saveCurrentAnswer()) {
            questionError.textContent = "Please choose an answer before proceeding to the next question.";
            questionError.classList.remove("hidden");
            return;
        }
        questionError.classList.add("hidden");

        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex += 1;
            renderQuestion(currentQuestionIndex);
        }
    });

    submitBtn.addEventListener("click", () => {
        if (!saveCurrentAnswer()) {
            questionError.textContent = "Please choose an answer before submitting.";
            questionError.classList.remove("hidden");
            return;
        }
        questionError.classList.add("hidden");
        handleSubmit(false);
    });

    // ===============================
    // 7. SUBMISSION
    // ===============================
    async function handleSubmit(autoSubmitted) {
        // Avoid double calls from manual and auto submissions
        submitBtn.disabled = true;
        nextBtn.disabled = true;
        reviewBtn.disabled = true;

        stopTimer();

        const score = computeScore();
        const answerSheet = buildAnswerSheet();

        const payload = {
            Course: courseTitle,
            submissionDate: serverTimestamp(),
            Score: score,
            Name: studentName,
            secondsRemaining: remainingSeconds,
            section: studentSection,
            answers: answerSheet,
            autoSubmitted: autoSubmitted
        };

        try {
            await addDoc(submissionsCollectionRef, payload);
            alert("Your exam has been submitted.");
            // On success, permanently disable submit button
            submitBtn.disabled = true;
        } catch (error) {
            console.error("Submission error:", error);
            alert("Submission fail, please try again.");
            // Re-enable buttons so student can retry
            submitBtn.disabled = false;
            nextBtn.disabled = false;
            reviewBtn.disabled = false;
        }
    }

    // Initial check for closing time on load
    updateClosingMessageIfNeeded();
</script>
</body>
</html>
